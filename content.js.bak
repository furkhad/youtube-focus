/**
 * YouTube Content Script - AI-Powered Filtering (Safe Mode)
 * - Hides videos initially while asking the background AI
 * - Shows videos on AI approval or on timeout/failure (fail-safe)
 * - Prevents infinite auto-digging by limiting attempts
 */

// ============================================================================
// CONSTANTS & CONFIGURATION
// ============================================================================

const GLOBAL_BLOCKLIST = new Set(['shorts', 'prank', 'reaction', 'gameplay', 'gossip', 'meme', 'viral', 'challenge']);
const STOPWORDS = new Set(['i', 'want', 'to', 'see', 'show', 'me', 'only', 'about', 'videos', 'the', 'a', 'an', 'and', 'or', 'but', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'can', 'clip', 'clips']);

// CSS Class Names
const CLASS_CHECKED = 'focus-checked';
const CLASS_HIDDEN = 'focus-hidden';
const CLASS_BLUR = 'focus-blur';
const SPACER_ID = 'focus-spacer';

// Configuration
const MIN_VISIBLE_VIDEOS = 4;
const AI_TIMEOUT_MS = 1200; // per-video timeout: show on timeout
const MAX_AUTO_DIG_ATTEMPTS = 5; // stop auto-digging after this many tries
const DEBUG_MODE = true;
const DEBOUNCE_DELAY = 200;

// State
let observer = null;
let lastAutoDigTime = 0;
let autoDigAttempts = 0;
let currentGoal = '';

// ============================================================================
// CSS INJECTION
// ============================================================================

function injectFocusStyles() {
    if (document.getElementById('youtube-focus-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'youtube-focus-styles';
    style.textContent = `
        .${CLASS_HIDDEN} { display: none !important; }
        .${CLASS_BLUR} { opacity: 0.1 !important; filter: blur(5px) !important; pointer-events: none !important; }
        .${CLASS_CHECKED} { /* Marker */ }

        #${SPACER_ID} {
            min-height: 100vh !important; width: 100% !important;
            display: flex !important; align-items: flex-start !important; justify-content: center !important;
            padding-top: 16px !important; pointer-events: none !important; color: #fff;
        }

        #focus-hud {
            position: fixed !important; bottom: 0 !important; left: 0 !important; width: 100% !important;
            background: rgba(10, 10, 18, 0.9) !important; color: #00ff9d !important;
            font-family: monospace !important; padding: 6px 14px !important; z-index: 9999 !important;
            display: flex !important; justify-content: space-between !important; pointer-events: none !important;
        }
    `;
    (document.head || document.documentElement).appendChild(style);
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function debugLog(...args) {
    if (DEBUG_MODE) console.log('[YouTube Focus]', ...args);
}

function normalizeString(str) {
    return str ? str.toLowerCase().trim().replace(/\s+/g, ' ') : '';
}

function extractWords(text) {
    return normalizeString(text).split(/[\s.,!?;:()\[\]{}'\"]+/).filter(w => w.length > 0);
}

function parseUserGoal(goalString) {
    if (!goalString) return [];
    return extractWords(goalString).filter(w => w.length >= 2 && !STOPWORDS.has(w));
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// ============================================================================
// DOM HELPERS
// ============================================================================

function isElementProcessed(element) {
    return element && element.classList.contains(CLASS_CHECKED);
}

function markElementProcessed(element) {
    if (!element) return;
    element.classList.add(CLASS_CHECKED);
}

function hideVideoElement(element) {
    if (!element) return;
    element.classList.add(CLASS_HIDDEN);
}

function showVideoElement(element) {
    if (!element) return;
    element.classList.remove(CLASS_HIDDEN);
}

function resetVideoElement(element) {
    if (!element) return;
    element.classList.remove(CLASS_CHECKED);
    element.classList.remove(CLASS_HIDDEN);
    element.classList.remove(CLASS_BLUR);
}

function removeShorts() {
    const shortsBtn = document.querySelector('a[title="Shorts"]');
    if (shortsBtn) hideVideoElement(shortsBtn);
}

function extractVideoTitle(container) {
    if (!container) return null;
    const titleEl = container.querySelector('#video-title');
    return titleEl ? (titleEl.innerText || titleEl.textContent || '').trim() : null;
}

// ============================================================================
// HUD & SCANNER
// ============================================================================

function updateScanner(total, visible, active) {
    const grid = document.querySelector('ytd-rich-grid-renderer') || document.querySelector('#contents');
    if (!grid) return;
    let scanner = document.getElementById(SPACER_ID);
    if (!active || total === 0) { if (scanner) scanner.remove(); return; }
    if (!scanner) { scanner = document.createElement('div'); scanner.id = SPACER_ID; grid.appendChild(scanner); }
    scanner.textContent = `üîç AI Focus Protocol: Scanned ${total} | Visible ${visible}`;
}

function updateHUD(total, hidden, active) {
    let hud = document.getElementById('focus-hud');
    if (!active) { if (hud) hud.remove(); return; }
    if (!hud) { hud = document.createElement('div'); hud.id = 'focus-hud'; document.body.appendChild(hud); }
    hud.innerHTML = `<span>üõ°Ô∏è AI Active</span> <span>Scanned: ${total} | Hidden: ${hidden}</span>`;
}

function showSearchFallback(target) {
    let fallback = document.getElementById('focus-fallback');
    if (!fallback) {
        fallback = document.createElement('div'); fallback.id = 'focus-fallback';
        const card = document.createElement('div'); card.className = 'focus-fallback-card';
        const title = document.createElement('div'); title.className = 'focus-fallback-title';
        const button = document.createElement('button'); button.className = 'focus-fallback-button'; button.type = 'button';
        card.appendChild(title); card.appendChild(button); fallback.appendChild(card); document.body.appendChild(fallback);
    }
    const titleNode = fallback.querySelector('.focus-fallback-title');
    const buttonNode = fallback.querySelector('.focus-fallback-button');
    if (titleNode) titleNode.innerHTML = `No <span class="focus-fallback-target">${target}</span> videos found in your feed.`;
    if (buttonNode) { buttonNode.textContent = `Search for "${target}" instead`; buttonNode.onclick = () => { window.location.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(target)}`; }; }
}

function hideSearchFallback() { const f = document.getElementById('focus-fallback'); if (f) f.remove(); }

// ============================================================================
// COMMUNICATION WITH BACKGROUND WITH TIMEOUT
// ============================================================================

function classifyTitleWithTimeout(title, goal, timeoutMs = AI_TIMEOUT_MS) {
    return new Promise((resolve) => {
        let finished = false;
        const timer = setTimeout(() => {
            if (finished) return;
            finished = true;
            debugLog('AI timeout for:', title.substring(0, 60));
            resolve({ timeout: true, shouldShow: true, error: 'timeout' });
        }, timeoutMs);

        try {
            chrome.runtime.sendMessage({ type: 'classify', title, goal }, (resp) => {
                if (finished) return;
                finished = true;
                clearTimeout(timer);
                if (chrome.runtime.lastError) {
                    debugLog('Msg failed:', chrome.runtime.lastError.message);
                    resolve({ error: true, shouldShow: true, errorMsg: chrome.runtime.lastError.message });
                } else {
                    resolve(resp || { shouldShow: true, error: 'no-response' });
                }
            });
        } catch (err) {
            if (finished) return;
            finished = true;
            clearTimeout(timer);
            resolve({ error: true, shouldShow: true, errorMsg: String(err) });
        }
    });
}

// ============================================================================
// VIDEO PROCESSING & AUTO-DIGGING SAFETY
// ============================================================================

async function processContainer(container) {
    if (!container || isElementProcessed(container)) return;

    markElementProcessed(container);

    // Hide immediately (loading state)
    hideVideoElement(container);

    const title = extractVideoTitle(container);

    if (!title) {
        // If no title available, show (fail-safe)
        showVideoElement(container);
        return;
    }

    const result = await classifyTitleWithTimeout(title, currentGoal, AI_TIMEOUT_MS);

    // Decision rules (fail-safe -> show)
    if (!result || result.error || result.loading || result.timeout) {
        showVideoElement(container);
        debugLog('AI unavailable or timeout, showing:', title.substring(0, 60));
        return;
    }

    if (result.shouldShow) {
        showVideoElement(container);
        debugLog('AI APPROVED:', title.substring(0, 60));
    } else {
        // Keep hidden
        debugLog('AI BLOCKED:', title.substring(0, 60));
    }
}

function countVisibleVideos() {
    const all = document.querySelectorAll('ytd-rich-item-renderer');
    let visible = 0;
    all.forEach(el => { if (!el.classList.contains(CLASS_HIDDEN)) visible++; });
    return { total: all.length, visible };
}

function safeAutoDigIfNeeded() {
    const counts = countVisibleVideos();
    if (counts.visible >= MIN_VISIBLE_VIDEOS) { autoDigAttempts = 0; hideSearchFallback(); return; }
    if (autoDigAttempts >= MAX_AUTO_DIG_ATTEMPTS) {
        debugLog('Max auto-dig attempts reached, stopping further auto-digs');
        showSearchFallback(currentGoal || 'focus');
        return;
    }

    const now = Date.now();
    if (now - lastAutoDigTime < 1000) return;
    lastAutoDigTime = now;
    autoDigAttempts++;
    debugLog('Auto-digging (attempt', autoDigAttempts, ')');
    window.scrollBy(0, 500);
    setTimeout(() => window.scrollBy(0, -1), 150);
}

// ============================================================================
// OBSERVER SETUP & BOOT
// ============================================================================

const debouncedProcessNew = debounce(() => {
    const nodes = Array.from(document.querySelectorAll('ytd-rich-item-renderer:not(.' + CLASS_CHECKED + ')'));
    nodes.forEach(n => processContainer(n));
    const counts = countVisibleVideos();
    updateScanner(counts.total, counts.visible, true);
    updateHUD(counts.total, counts.total - counts.visible, true);
    safeAutoDigIfNeeded();
}, DEBOUNCE_DELAY);

function setupObserver() {
    const target = document.querySelector('ytd-rich-grid-renderer') || document.querySelector('#contents') || document.body;
    observer = new MutationObserver((mutations) => {
        // Quickly process new video nodes (debounced)
        debouncedProcessNew();
    });
    observer.observe(target, { childList: true, subtree: true });
    debugLog('Observer started');
}

// Load user's goal from storage and listen for changes
function loadGoal() {
    chrome.storage.local.get(['focusGoal'], (res) => {
        currentGoal = (res && res.focusGoal) ? res.focusGoal.trim() : '';
        debugLog('Loaded goal:', currentGoal);
        if (!currentGoal) {
            // If no goal, reset and show everything
            document.querySelectorAll('ytd-rich-item-renderer').forEach(resetVideoElement);
            updateScanner(0, 0, false);
            updateHUD(0, 0, [], false);
            hideSearchFallback();
        } else {
            // Kick off processing for existing items
            debouncedProcessNew();
        }
    });
}

chrome.storage.onChanged.addListener((changes, area) => {
    if (area === 'local' && changes.focusGoal) {
        currentGoal = (changes.focusGoal.newValue || '').trim();
        debugLog('Goal changed ->', currentGoal);
        // Re-process the feed when goal changes
        document.querySelectorAll('ytd-rich-item-renderer').forEach(el => { el.classList.remove(CLASS_CHECKED); });
        debouncedProcessNew();
    }
});

// Bootstrap
injectFocusStyles();
removeShorts();
loadGoal();
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupObserver);
} else {
    setupObserver();
}

debugLog('üöÄ YouTube Focus: Safe AI Filtering Active');
